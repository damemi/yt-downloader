<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube to MP4</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f0f0f;
      --surface: #1a1a1a;
      --border: #2a2a2a;
      --text: #e8e8e8;
      --muted: #888;
      --accent: #ff3b30;
      --accent-hover: #ff6b63;
      --success: #34c759;
      --success-hover: #5dd879;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'DM Sans', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 2rem;
      width: 100%;
      max-width: 520px;
    }
    h1 { font-size: 1.35rem; font-weight: 600; margin: 0 0 0.25rem 0; }
    .sub { color: var(--muted); font-size: 0.9rem; margin-bottom: 1.25rem; }
    label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.35rem; color: var(--muted); }
    input[type="url"], input[type="text"] {
      width: 100%;
      padding: 0.65rem 0.75rem;
      font: inherit;
      font-size: 0.95rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      margin-bottom: 0.5rem;
    }
    input::placeholder { color: var(--muted); }
    input:focus { outline: none; border-color: var(--accent); }
    .slot {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
    }
    .slot-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    .slot-title { font-size: 0.85rem; font-weight: 500; color: var(--muted); }
    .slot-remove {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 0.25rem;
      font-size: 1.1rem;
      line-height: 1;
      border-radius: 4px;
      width: 28px;
      height: 28px;
    }
    .slot-remove:hover { color: var(--text); background: var(--border); }
    .slot .row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0; }
    .slot .row label { margin-bottom: 0.25rem; }
    .add-slot {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.5rem 0.75rem;
      font: inherit;
      font-size: 0.9rem;
      color: var(--muted);
      background: transparent;
      border: 1px dashed var(--border);
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 1rem;
    }
    .add-slot:hover { color: var(--text); border-color: var(--muted); }
    .add-slot::before { content: '+'; font-size: 1.2rem; font-weight: 600; }
    .btn-download-all {
      width: 100%;
      padding: 0.75rem 1rem;
      font: inherit;
      font-size: 1rem;
      font-weight: 500;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .btn-download-all:hover { background: var(--accent-hover); }
    .btn-download-all:disabled { opacity: 0.6; cursor: not-allowed; }
    .progress-list { margin-top: 1.25rem; }
    .progress-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
    }
    .progress-card-head { font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--muted); }
    .progress-bar-wrap {
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 0.4rem;
    }
    .progress-bar {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
      width: 0%;
      transition: width 0.2s ease;
    }
    .progress-meta { font-size: 0.8rem; color: var(--muted); }
    .progress-card.ready .progress-bar-wrap { display: none; }
    .progress-card.ready .progress-meta { display: none; }
    .btn-save {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem 1rem;
      font: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      color: #fff;
      background: var(--success);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 0.25rem;
    }
    .btn-save:hover { background: var(--success-hover); }
    .progress-card.error .progress-meta { color: #ff6b63; }
    .global-error {
      margin-top: 1rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255, 59, 48, 0.15);
      border: 1px solid rgba(255, 59, 48, 0.4);
      border-radius: 8px;
      font-size: 0.9rem;
      color: #ff6b63;
      display: none;
    }
    .global-error.visible { display: block; }
    .hint { font-size: 0.8rem; color: var(--muted); margin-top: 0.25rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1>YouTube → MP4</h1>
    <p class="sub">Add one or more videos; set start/end to download clips. One download starts all.</p>
    <div id="slotsContainer"></div>
    <button type="button" class="add-slot" id="addSlot" aria-label="Add another video">Add video</button>
    <button type="button" class="btn-download-all" id="btnDownloadAll">Download all</button>
    <div class="progress-list" id="progressList"></div>
    <div class="global-error" id="globalError" role="alert"></div>
  </div>
  <script>
    const slotsContainer = document.getElementById('slotsContainer');
    const addSlotBtn = document.getElementById('addSlot');
    const btnDownloadAll = document.getElementById('btnDownloadAll');
    const progressList = document.getElementById('progressList');
    const globalError = document.getElementById('globalError');

    let slots = [{ url: '', start: '', end: '' }];
    let progress = [];

    function formatSpeed(bytesPerSec) {
      if (bytesPerSec == null) return '';
      const mb = bytesPerSec / (1024 * 1024);
      return mb >= 1 ? mb.toFixed(2) + ' MB/s' : (bytesPerSec / 1024).toFixed(1) + ' KB/s';
    }
    function formatEta(sec) {
      if (sec == null || sec < 0) return '';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return m ? m + 'm ' + s + 's' : s + 's';
    }

    function ensureProgressLength() {
      while (progress.length < slots.length) progress.push({
        status: 'idle',
        progressPct: 0,
        phase: '',
        eta_sec: null,
        speed: null,
        jobId: null,
        error: null,
        blobUrl: null
      });
      progress = progress.slice(0, slots.length);
    }

    function renderSlots() {
      slotsContainer.innerHTML = slots.map((s, i) => `
        <div class="slot" data-index="${i}">
          <div class="slot-head">
            <span class="slot-title">Video ${i + 1}</span>
            ${slots.length > 1 ? `<button type="button" class="slot-remove" data-index="${i}" aria-label="Remove">−</button>` : ''}
          </div>
          <label for="url-${i}">URL</label>
          <input type="url" id="url-${i}" data-index="${i}" data-field="url" placeholder="https://www.youtube.com/watch?v=..." value="${escapeAttr(s.url)}">
          <div class="row">
            <div>
              <label for="start-${i}">Start</label>
              <input type="text" id="start-${i}" data-index="${i}" data-field="start" placeholder="0 or 1:30" value="${escapeAttr(s.start)}">
            </div>
            <div>
              <label for="end-${i}">End</label>
              <input type="text" id="end-${i}" data-index="${i}" data-field="end" placeholder="5:00 or empty" value="${escapeAttr(s.end)}">
            </div>
          </div>
        </div>
      `).join('');
      slotsContainer.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('input', () => {
          const i = parseInt(inp.dataset.index, 10);
          const field = inp.dataset.field;
          if (slots[i]) slots[i][field] = inp.value;
        });
      });
      slotsContainer.querySelectorAll('.slot-remove').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = parseInt(btn.dataset.index, 10);
          slots.splice(i, 1);
          progress.splice(i, 1);
          renderSlots();
          renderProgress();
        });
      });
    }
    function escapeAttr(s) {
      if (s == null) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function renderProgress() {
      ensureProgressLength();
      progressList.innerHTML = progress.map((p, i) => {
        const label = `Video ${i + 1}`;
        const classes = ['progress-card', p.status];
        if (p.status === 'error') classes.push('error');
        if (p.status === 'ready') classes.push('ready');
        const pct = p.progressPct != null ? Math.min(100, Math.max(0, p.progressPct)) : 0;
        let meta = '';
        if (p.status === 'downloading') {
          const parts = [];
          if (p.phase) parts.push(p.phase === 'converting' ? 'Converting…' : 'Downloading…');
          if (p.progressPct != null) parts.push(p.progressPct.toFixed(1) + '%');
          if (p.eta_sec != null) parts.push('ETA ' + formatEta(p.eta_sec));
          if (p.speed != null) parts.push(formatSpeed(p.speed));
          meta = parts.join(' · ');
        } else if (p.status === 'error') meta = p.error || 'Failed';
        else if (p.status === 'ready') meta = '';
        else if (p.status === 'idle') meta = '—';
        const saveBtn = p.status === 'ready' && p.blobUrl
          ? `<button type="button" class="btn-save" data-index="${i}">Download</button>`
          : '';
        return `
          <div class="${classes.join(' ')}" data-index="${i}">
            <div class="progress-card-head">${label}</div>
            <div class="progress-bar-wrap"><div class="progress-bar" style="width:${pct}%"></div></div>
            <div class="progress-meta">${escapeAttr(meta)}</div>
            ${saveBtn}
          </div>
        `;
      }).join('');
      progressList.querySelectorAll('.btn-save').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = parseInt(btn.dataset.index, 10);
          const p = progress[i];
          if (!p || !p.blobUrl) return;
          const a = document.createElement('a');
          a.href = p.blobUrl;
          a.download = `clip-${i + 1}.mp4`;
          a.click();
          setTimeout(() => URL.revokeObjectURL(p.blobUrl), 1000);
        });
      });
      progressList.style.display = progress.some(p => p.status !== 'idle') ? '' : 'none';
    }

    async function startDownload(slotIndex) {
      const slot = slots[slotIndex];
      if (!slot || !slot.url || !slot.url.trim()) return;
      progress[slotIndex] = {
        status: 'downloading',
        progressPct: 0,
        phase: 'starting',
        eta_sec: null,
        speed: null,
        jobId: null,
        error: null,
        blobUrl: null
      };
      ensureProgressLength();
      renderProgress();

      const fd = new FormData();
      fd.set('url', slot.url.trim());
      fd.set('start', (slot.start || '0').trim());
      fd.set('end', (slot.end || '').trim());

      try {
        const res = await fetch('/download', { method: 'POST', body: fd });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || 'Download failed');
        }
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buf = '';
        let finished = false;
        while (!finished) {
          const { value, done } = await reader.read();
          if (done) break;
          buf += decoder.decode(value, { stream: true });
          const lines = buf.split('\n');
          buf = lines.pop() || '';
          for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            try {
              const data = JSON.parse(line.slice(6));
              if (data.status === 'progress') {
                progress[slotIndex].progressPct = data.progress_pct;
                progress[slotIndex].phase = data.phase || 'downloading';
                progress[slotIndex].eta_sec = data.eta_sec;
                progress[slotIndex].speed = data.speed;
                renderProgress();
              } else if (data.status === 'complete') {
                const r = await fetch('/download/result/' + data.job_id);
                if (!r.ok) throw new Error('Could not get file');
                const blob = await r.blob();
                progress[slotIndex].status = 'ready';
                progress[slotIndex].progressPct = 100;
                progress[slotIndex].blobUrl = URL.createObjectURL(blob);
                progress[slotIndex].phase = '';
                renderProgress();
                finished = true;
                break;
              } else if (data.status === 'error') {
                throw new Error(data.error || 'Download failed');
              }
            } catch (err) {
              if (err instanceof SyntaxError) continue;
              throw err;
            }
          }
        }
        if (!finished && buf.startsWith('data: ')) {
          try {
            const data = JSON.parse(buf.slice(6));
            if (data.status === 'error') throw new Error(data.error || 'Download failed');
          } catch (err) {
            if (err instanceof SyntaxError) { /* ignore */ } else throw err;
          }
        }
      } catch (err) {
        progress[slotIndex].status = 'error';
        progress[slotIndex].error = err.message || 'Failed';
        renderProgress();
      }
    }

    addSlotBtn.addEventListener('click', () => {
      slots.push({ url: '', start: '', end: '' });
      ensureProgressLength();
      renderSlots();
    });

    btnDownloadAll.addEventListener('click', async () => {
      globalError.classList.remove('visible');
      globalError.textContent = '';
      const withUrl = slots.map((s, i) => ({ slot: s, i })).filter(({ slot }) => slot.url && slot.url.trim());
      if (withUrl.length === 0) {
        globalError.textContent = 'Add at least one video URL.';
        globalError.classList.add('visible');
        return;
      }
      btnDownloadAll.disabled = true;
      await Promise.all(withUrl.map(({ i }) => startDownload(i)));
      btnDownloadAll.disabled = false;
    });

    renderSlots();
    ensureProgressLength();
    renderProgress();
  </script>
</body>
</html>
